{
    "cells": [
        {
            "cell_type": "code",
            "execution_count": null,
            "id": "15795bac",
            "metadata": {},
            "outputs": [],
            "source": [
                "# Todos direitos de cópia reservados para Guilherme Menegon Arantes, IQ-USP, Brasil.\n",
                "# Este material não pode ser reproduzido, copiado ou distribuído sem permissão do autor.\n",
                "import numpy as np\n",
                "import py3Dmol\n",
                "import matplotlib.pyplot as plt\n",
                "from matplotlib.widgets import Slider, Button, RadioButtons\n",
                "from IPython.display import HTML, display\n",
                "from ipywidgets import interact, interactive, Layout, ToggleButtons, SelectionSlider\n",
                "from typing import Any\n",
                "\n",
                "# Plots style\n",
                "import json\n",
                "import matplotlib as mpl\n",
                "\n",
                "s = json.load(open(\"../DATA/styles/matplotlibrc.json\"))\n",
                "mpl.rcParams.update(s)\n",
                "\n",
                "## backend\n",
                "%matplotlib widget\n",
                "## backend"
            ]
        },
        {
            "cell_type": "markdown",
            "id": "498ad69e",
            "metadata": {},
            "source": [
                "# Interações moleculares - Notas de aula\n",
                "<p></p>\n",
                "<div style=\"text-align: right\">\n",
                "<a href=\"http://gaznevada.iq.usp.br:8080/voila/render/notebooks/index.ipynb\" style=\"font-size: x-large;\">Índice</a>\n",
                "</div>"
            ]
        },
        {
            "cell_type": "markdown",
            "id": "b655d7f4",
            "metadata": {},
            "source": [
                "## Contribuições covalentes <a class=\"anchor\" id=\"covalent\"></a>"
            ]
        },
        {
            "cell_type": "markdown",
            "id": "35b0d016",
            "metadata": {},
            "source": [
                "### Energia de estiramento de ligação covalente <a class=\"anchor\" id=\"bond\"></a>"
            ]
        },
        {
            "cell_type": "markdown",
            "id": "f8a8de59",
            "metadata": {},
            "source": [
                "<div style=\"text-align: justify\"> Começamos pela energia de estiramento de uma ligação covalente. Mas, o que é este processo? Veja abaixo dois exemplos para as moléculas de água (H<sub>2</sub>O) e de nitrogênio (N<sub>2</sub>). Escolha a molécula, altere o controle e observe a geometria. Você também pode alterar sua orientação, clicando na molécula e arrastando: </div>"
            ]
        },
        {
            "cell_type": "code",
            "execution_count": null,
            "id": "8dc42f95",
            "metadata": {},
            "outputs": [],
            "source": [
                "# cov_geometry\n",
                "def load_xyz(mol: str) -> list:\n",
                "    path = \"../DATA/geometries/\" + mol + \"_files.txt\"\n",
                "    geo_list = []\n",
                "\n",
                "    with open(path, 'r') as f:\n",
                "        for line in f:\n",
                "            geo_list.append(line.rstrip())\n",
                "\n",
                "    return geo_list\n",
                "\n",
                "def init_viewer(\n",
                "    xyz: str, style: dict, xyz_rot: list,\n",
                "    zoom: float, var_label: str, options: dict\n",
                "    ) -> Any:\n",
                "    viewer = py3Dmol.view(width=400, height=200)\n",
                "    viewer.addModel(xyz, 'xyz')\n",
                "    viewer.setStyle(style)\n",
                "    viewer.addLabel(var_label, options)\n",
                "    viewer.rotate(xyz_rot[0], 'x')\n",
                "    viewer.rotate(xyz_rot[1], 'y')\n",
                "    viewer.rotate(xyz_rot[2], 'z')\n",
                "    viewer.zoomTo()\n",
                "    viewer.zoom(zoom)\n",
                "\n",
                "    return viewer\n",
                "\n",
                "def cov_display(filename: str) -> None:\n",
                "    filepath = \"../DATA/geometries/\" + filename\n",
                "    with open(filepath, 'r') as f:\n",
                "        xyz = f.read()\n",
                "        style = {'sphere': {}}\n",
                "        options = {\n",
                "                'position': {'x':200.0, 'y':196.0, 'z':-0.0}, 'useScreen': True, 'backgroundColor': 'white',\n",
                "                'fontColor': 'black', 'backgroundOpacity': 0.5,'alignment': 'bottomCenter'\n",
                "                }\n",
                "\n",
                "        if cov_buttons.value == 'h2o':\n",
                "            cov_n2_sl.value = cov_n2_sl.options[0] # reset other slider\n",
                "            distance = filepath[23:27]\n",
                "            xyz_rot = [90, 250, 0]\n",
                "            zoom = 1.8\n",
                "            var_label = \"Distância r = {} Å\".format(distance)\n",
                "            viewer = init_viewer(xyz, style, xyz_rot, zoom, var_label, options)\n",
                "            \n",
                "        elif cov_buttons.value == \"n2\":\n",
                "            cov_h2o_sl.value = cov_h2o_sl.options[0] # reset other slider\n",
                "            distance = filepath[22:26]\n",
                "            xyz_rot = [0, 0, 0]\n",
                "            zoom = 2.0\n",
                "            var_label = \"Distância r = {} Å\".format(distance)\n",
                "            viewer = init_viewer(xyz, style, xyz_rot, zoom, var_label, options)\n",
                "\n",
                "    viewer.show()\n",
                "\n",
                "## ipy_tb\n",
                "TB_LAYOUT = Layout(margin ='0 100px 0 0')\n",
                "## ipy_tb\n",
                "## ipy_ss\n",
                "SS_LAYOUT = Layout(margin ='0 100px 0 0')\n",
                "## ipy_ss\n",
                "\n",
                "cov_buttons = ToggleButtons(\n",
                "    options=[('água', 'h2o'), ('nitrogênio','n2')], description = ' ',\n",
                "    layout=TB_LAYOUT\n",
                "    )\n",
                "\n",
                "cov_h2o_sl = SelectionSlider(\n",
                "    options = load_xyz('h2o'), readout = False, description = ' ',\n",
                "    layout=SS_LAYOUT\n",
                "    )\n",
                "\n",
                "cov_n2_sl = SelectionSlider(\n",
                "    options = load_xyz('n2'), readout = False, description = ' ',\n",
                "    layout=SS_LAYOUT\n",
                "    )\n",
                "\n",
                "@interact(molecule = cov_buttons)\n",
                "def cov_seletor(molecule):\n",
                "    if molecule == 'h2o':\n",
                "        slider = cov_h2o_sl\n",
                "    else:\n",
                "        slider = cov_n2_sl\n",
                "\n",
                "    out = interactive(cov_display, filename = slider)\n",
                "    display(out)"
            ]
        },
        {
            "cell_type": "markdown",
            "id": "d8045996",
            "metadata": {},
            "source": [
                "<div style=\"text-align: justify\"> Ou seja, o estiramento corresponde à separação entre os átomos que formam uma ligação covalente. Nesta representação gráfica, os átomos correspondem a simples esferas coloridas e os elétrons ou sua densidade não são mostrados.</div>"
            ]
        },
        {
            "cell_type": "markdown",
            "id": "0d1c953c",
            "metadata": {},
            "source": [
                "<div style=\"text-align: justify\">A energia de estiramento $\\mathcal{V}_\\text{lig}$ pode ser descrita por uma função harmônica ou uma parábola, como se a ligação covalente fosse uma mola: </div>\n",
                "\n",
                "$$\\mathcal{V}_\\text{lig} = \\sum_\\text{lig} \\frac{1}{2} k_m (r - r_0)^2$$\n",
                "  \n",
                "<div style=\"text-align: justify\"> onde cada ligação covalente definida possui uma constante de força $k_m$, que expressa a rigidez da mola, uma distância de equilíbrio $r_0$, em que a energia de seu estiramento é mínima, e a distância $r$ entre os dois átomos ligados como mostrado nos exemplos acima. A somatória corre sobre todas ligações covalentes presentes no sistema molecular. Por exemplo, para um sistema composto por apenas uma molécula de água, a somatória teria dois termos correspondentes ao estiramento de cada ligação O$-$H.</div>"
            ]
        },
        {
            "cell_type": "markdown",
            "id": "b1aa84f5",
            "metadata": {},
            "source": [
                "<div style=\"text-align: justify\"> A função harmônica é capaz de descrever a energia apenas em separações $r$ próximas à distância de equilíbrio. Para um maior intervalo de $r$, uma função anarmônica como aquela proposta por Morse é mais apropriada: </div>\n",
                "\n",
                "$$\\mathcal{V}_\\text{Morse} = \\sum_\\text{lig} D_e \\left(1-\\exp{[-\\beta (r-r_0)]}\\right)^2$$\n",
                "\n",
                "<div style=\"text-align: justify\"> onde além de $r_0$, temos dois parâmetros adicionais, a energia de dissociação da ligação $D_e$, e a largura do potencial $\\beta$. </div>"
            ]
        },
        {
            "cell_type": "markdown",
            "id": "af3d7a96",
            "metadata": {},
            "source": [
                "<div style=\"text-align: justify\"> O gráfico abaixo mostra a energia ao longo da distância de estiramento $r$ calculada por mecânica quântica (bolinhas pretas) e pelas equações apresentadas acima. Mecânica quântica nos dá um valor de referência, ou seja, próximo do valor observado num experimento. Escolha a molécula e a equação, e teste o efeito dos parâmetros (por exemplo, constante de força $k_m$) na forma da curva calculada: </div>"
            ]
        },
        {
            "cell_type": "code",
            "execution_count": null,
            "id": "082a91bf",
            "metadata": {},
            "outputs": [],
            "source": [
                "# pot_plot\n",
                "def init_pot_plot():\n",
                "    fig, ax = plt.subplots(figsize=[6.7, 4])\n",
                "    fig.subplots_adjust(left=0.15, bottom=0.3, right=0.75)\n",
                "    \n",
                "    title = r\"Potencial harmônico: $\\mathcal{V}_{lig} = \\frac{k_m}{2}(r-r_0)^2$\"\n",
                "    ax.set_title(title, fontsize=12,pad=13, loc='center')\n",
                "    ax.axis([0, 6, 0.0, 3000.0])\n",
                "    \n",
                "    xlabel = u'Distância $r$ ($\\AA$)'\n",
                "    ylabel = u'Energia relativa (kJ/mol)'\n",
                "    ax.set_xlabel(xlabel, labelpad=1, fontsize=12)\n",
                "    ax.set_ylabel(ylabel, labelpad=5, fontsize=12)\n",
                "    \n",
                "    ## matplotlib_layout\n",
                "    fig.canvas.resizable = False\n",
                "    fig.canvas.toolbar_visible = False\n",
                "    fig.canvas.header_visible = False\n",
                "    ## matplotlib_layout\n",
                "    return fig, ax\n",
                "\n",
                "def get_pot_ref():\n",
                "    files = ['../DATA/ref/ref_H2O.dat', '../DATA/ref/ref_N2.dat']\n",
                "    ref = []\n",
                "    for filename in files:\n",
                "        with open(filename) as f:\n",
                "            table = []\n",
                "            for row in f:\n",
                "                row = row.split()\n",
                "                table += [[float(row[0]), float(row[1])]]\n",
                "            ref.append(table)\n",
                "    h2o = np.array(ref[0])\n",
                "    n2 = np.array(ref[1])\n",
                "    return h2o, n2\n",
                "\n",
                "def Morse(r, r0, De, beta):\n",
                "    exp = np.exp(-beta*(r-r0))\n",
                "    return (De * (1-exp)**2)\n",
                "\n",
                "def Harm(r, r0, k):\n",
                "    return (k/2 * (r- r0)**2)\n",
                "\n",
                "# Init plot\n",
                "pot_fig, pot_ax = init_pot_plot()\n",
                "\n",
                "plt.show()\n",
                "pot_fig.canvas.draw()\n",
                "\n",
                "# plot ref\n",
                "h2o, n2 = get_pot_ref()\n",
                "h2o = pot_ax.scatter(h2o[:,0], h2o[:,1], visible=True, color='black')\n",
                "n2 = pot_ax.scatter(n2[:,0], n2[:,1], visible=False, color='black')\n",
                "\n",
                "t = np.arange(0.1, 6.0, 0.02)\n",
                "\n",
                "# plot potentials\n",
                "harm, = pot_ax.plot(\n",
                "    t, Harm(t, r0=2.0, k=200.0),\n",
                "    color='#8E8EFD'\n",
                ")\n",
                "\n",
                "morse, = pot_ax.plot(\n",
                "    t, Morse(t, r0=2.0, De=500, beta=2),\n",
                "    color='#EB0000', visible=False\n",
                ")\n",
                "\n",
                "vl = pot_ax.axvline(\n",
                "    x=2.0, color='#ffa600', linestyle='--',\n",
                "    lw=1, visible=True\n",
                ")\n",
                "\n",
                "\n",
                "# Sliders\n",
                "r0_sl = Slider(\n",
                "    plt.axes([0.075, 0.1, 0.3, 0.02]), r'r$_0$',\n",
                "    valmin=0.001, valmax=4.0, valinit=2.0, color='#FFA600'\n",
                ")\n",
                "\n",
                "km_sl = Slider(\n",
                "    plt.axes([0.075, 0.14, 0.3, 0.02]), r'$k_m$',\n",
                "    valmin=0.001, valmax=20_000.0, valinit=200.0, color='#8E8EFD'\n",
                ")\n",
                "\n",
                "De_sl = Slider(\n",
                "    plt.axes([0.515, 0.1, 0.3, 0.02]), r'D$_e$',\n",
                "    valmin=0.001, valmax=3_000.0, valinit=500.0, color='#EB0000'\n",
                ")\n",
                "\n",
                "beta_sl = Slider(\n",
                "    plt.axes([0.515, 0.14, 0.3, 0.02]), r'$\\beta$',\n",
                "    valmin=0.001, valmax=10.0, valinit=2.0, color='#EB0000'\n",
                ")\n",
                "\n",
                "# Styling sliders\n",
                "pot_sliders = [r0_sl, km_sl, De_sl, beta_sl]\n",
                "for sl in pot_sliders:\n",
                "    sl.vline.set_color('k')\n",
                "    sl.label.set_size(12)\n",
                "\n",
                "# Sync with update funcion\n",
                "def pot_update(val):\n",
                "    r0 = r0_sl.val\n",
                "    km = km_sl.val\n",
                "    De = De_sl.val\n",
                "    beta = beta_sl.val\n",
                "    \n",
                "    vl.set_xdata(r0)\n",
                "    harm.set_ydata(Harm(t, r0, km))\n",
                "    morse.set_ydata(Morse(t, r0, De, beta))\n",
                "    \n",
                "    pot_fig.canvas.draw_idle()\n",
                "\n",
                "_ = r0_sl.on_changed(pot_update)\n",
                "_ = km_sl.on_changed(pot_update)\n",
                "_ = De_sl.on_changed(pot_update)\n",
                "_ = beta_sl.on_changed(pot_update)\n",
                "\n",
                "# Potential buttons\n",
                "potential_rb = RadioButtons(\n",
                "    plt.axes([0.77, 0.54, 0.095, 0.14], facecolor=\"#F5F6FA\"),\n",
                "    ('$\\mathcal{V}_{lig}$', '$\\mathcal{V}_{Morse}$')\n",
                ")\n",
                "\n",
                "def pot_change_func(label):\n",
                "    if potential_rb.value_selected == '$\\mathcal{V}_{lig}$':\n",
                "        harm.set_visible(True)\n",
                "        morse.set_visible(False)\n",
                "        title = r\"Potencial harmônico: $\\mathcal{V}_{lig} = \\frac{k_m}{2}(r-r_0)^2$\"\n",
                "        pot_ax.set_title(title, fontsize=12,pad=13, loc='center')\n",
                "    else:\n",
                "        harm.set_visible(False)\n",
                "        morse.set_visible(True)\n",
                "        title = r\"Potencial anarmônico: $\\mathcal{V}_{Morse} = D_e \\left[ 1-e^{-\\beta(r - r_0 )} \\right]^2$\"\n",
                "        pot_ax.set_title(title, fontsize=12,pad=13, loc='center')\n",
                "        \n",
                "_ = potential_rb.on_clicked(pot_change_func)\n",
                "\n",
                "# Ref buttons\n",
                "pot_ref_rb = RadioButtons(\n",
                "    plt.axes([0.77, 0.74, 0.095, 0.14], facecolor=\"#F5F6FA\"),\n",
                "    ('H$_2$O', 'N$_2$')\n",
                ")\n",
                "\n",
                "def pot_change_ref(label):\n",
                "    if pot_ref_rb.value_selected == 'H$_2$O':\n",
                "        h2o.set_visible(True)\n",
                "        n2.set_visible(False)\n",
                "    else:\n",
                "        h2o.set_visible(False)\n",
                "        n2.set_visible(True)\n",
                "_ = pot_ref_rb.on_clicked(pot_change_ref)\n",
                "\n",
                "# Reset button\n",
                "pot_reset_bt  = Button(\n",
                "    plt.axes([0.77, 0.4, 0.095, 0.04]),\n",
                "    'Reiniciar', color='#DCDDE1', hovercolor='#F5F6FA'\n",
                ")\n",
                "\n",
                "def pot_reset(event):\n",
                "    r0_sl.reset()\n",
                "    km_sl.reset()\n",
                "    De_sl.reset()\n",
                "    beta_sl.reset()\n",
                "_ = pot_reset_bt.on_clicked(pot_reset)\n",
                "\n",
                "# Fit button\n",
                "pot_fit_bt = Button(\n",
                "    plt.axes([0.77, 0.3, 0.095, 0.04]),\n",
                "    label='Ajustar', color='#DCDDE1', hovercolor='#F5F6FA'\n",
                ")\n",
                "\n",
                "def pot_fit(event):\n",
                "    if potential_rb.value_selected == '$\\mathcal{V}_{lig}$' and pot_ref_rb.value_selected == 'H$_2$O':\n",
                "        r0_sl.set_val(0.95)\n",
                "        km_sl.set_val(1946.52)\n",
                "    elif potential_rb.value_selected == '$\\mathcal{V}_{lig}$' and pot_ref_rb.value_selected == 'N$_2$':\n",
                "        r0_sl.set_val(1.15)\n",
                "        km_sl.set_val(12919.78)\n",
                "    elif potential_rb.value_selected == '$\\mathcal{V}_{Morse}$' and pot_ref_rb.value_selected == 'H$_2$O':\n",
                "        r0_sl.set_val(0.95)\n",
                "        beta_sl.set_val(1.20)\n",
                "        De_sl.set_val(1000.65)\n",
                "    elif potential_rb.value_selected == '$\\mathcal{V}_{Morse}$' and pot_ref_rb.value_selected == 'N$_2$':\n",
                "        r0_sl.set_val(1.1)\n",
                "        beta_sl.set_val(1.57)\n",
                "        De_sl.set_val(2515.0)\n",
                "_ = pot_fit_bt.on_clicked(pot_fit)"
            ]
        },
        {
            "cell_type": "markdown",
            "id": "b6a9eeb0",
            "metadata": {},
            "source": [
                "### Energia de deformação angular <a class=\"anchor\" id=\"angle\"></a>"
            ]
        },
        {
            "cell_type": "markdown",
            "id": "e00980e0",
            "metadata": {},
            "source": [
                "<div style=\"text-align: justify\"> A energia envolvida na alteração do ângulo formado entre duas ligações covalentes consecutivas $\\mathcal{V}_\\text{ang}$ também pode ser expressa por um potencial harmônico: </div>\n",
                "\n",
                "$$\\mathcal{V}_\\text{ang} = \\sum_\\text{ang} \\frac{1}{2} k_{\\theta} (\\mathbf{\\theta} - \\theta_0)^2$$\n",
                "\n",
                "<div style=\"text-align: justify\"> onde agora cada ângulo definido possui um valor $\\theta$ dado pela estrutura da molécula, uma constante de força $k_{\\theta}$ e um valor de equilíbrio $\\theta_0$. A somatória corre sobre todos os ângulos presentes no sistema. Por exemplo, em um sistema com três moléculas de água, esta somatória teria três termos correspondentes ao ângulo entre as ligações H$-$O$-$H de cada uma das três moléculas.</div>"
            ]
        },
        {
            "cell_type": "markdown",
            "id": "0404fe66",
            "metadata": {},
            "source": [
                "### Energia de torção de uma ligação covalente <a class=\"anchor\" id=\"dihedral\"></a>"
            ]
        },
        {
            "cell_type": "markdown",
            "id": "37637713",
            "metadata": {},
            "source": [
                "<div style=\"text-align: justify\"> O último tipo de contribuição é a energia de torção em torno de uma ligação covalente. Esta torção é descrita por um ângulo diedral $\\phi$, conforme mostrado abaixo. Exceto para butano, as moléculas mostradas possuem apenas uma torção na ligação central. Butano possui 3 torções em torno de suas 3 ligações C$-$C, mas aqui consideramos apenas a torção da ligação C$_2-$C$_3$. Na representação gráfica mostrada abaixo, os átomos e suas ligações covalentes correspondem a simples bastões coloridos. Escolha a molécula e altere o controle para visualizar a mudança da geometria e de seu ângulo diedral correspondente: </div> "
            ]
        },
        {
            "cell_type": "code",
            "execution_count": null,
            "id": "df777164",
            "metadata": {},
            "outputs": [],
            "source": [
                "# dih_geometry\n",
                "def dih_display(filename: str) -> None:\n",
                "    filepath = \"../DATA/geometries/\" + filename\n",
                "    with open(filepath, 'r') as f:\n",
                "        xyz = f.read()\n",
                "        style = {'stick':{'colorscheme': 'greenCarbon'}}\n",
                "        options = {\n",
                "            'position': {'x':200.0, 'y':196.0, 'z':-0.0},'useScreen': True,\n",
                "            'backgroundColor': 'white','fontColor': 'black',\n",
                "            'backgroundOpacity': 0.5,'alignment': 'bottomCenter'\n",
                "            }\n",
                "\n",
                "        if dih_buttons.value == 'hooh':\n",
                "            # reset other sliders\n",
                "            dih_etane_sl.value = dih_etane_sl.options[0]\n",
                "            dih_etene_sl.value = dih_etene_sl.options[0]\n",
                "            dih_butane_sl.value = dih_butane_sl.options[0]\n",
                "\n",
                "            # get angle value from filepath\n",
                "            angle = filepath[24:27]\n",
                "            if angle.lstrip(\"0\") == '':\n",
                "                angle = \"0\"\n",
                "            else:\n",
                "                angle = angle.lstrip(\"0\")\n",
                "            \n",
                "            style = {'stick':{}}\n",
                "            xyz_rot = [30, 0, 0]\n",
                "            zoom = 3.5\n",
                "            var_label = \"Ângulo diedral ϕ = {}°\".format(angle)\n",
                "            viewer = init_viewer(xyz, style, xyz_rot, zoom, var_label, options)\n",
                "\n",
                "        elif dih_buttons.value == \"etane\":\n",
                "            # reset other sliders\n",
                "            dih_hooh_sl.value = dih_hooh_sl.options[0]\n",
                "            dih_etene_sl.value = dih_etene_sl.options[0]\n",
                "            dih_butane_sl.value = dih_butane_sl.options[0]\n",
                "\n",
                "            # get angle value from filepath\n",
                "            angle = filepath[25:28]\n",
                "            if angle.lstrip(\"0\") == '':\n",
                "                angle = \"0\"\n",
                "            else:\n",
                "                angle = angle.lstrip(\"0\")\n",
                "\n",
                "            xyz_rot = [0, 0, 0]\n",
                "            zoom = 1.8\n",
                "            var_label = \"Ângulo diedral ϕ = {}°\".format(angle)\n",
                "            viewer = init_viewer(xyz, style, xyz_rot, zoom, var_label, options)\n",
                "\n",
                "        elif dih_buttons.value == \"etene\":\n",
                "            # reset other sliders\n",
                "            dih_hooh_sl.value = dih_hooh_sl.options[0]\n",
                "            dih_etane_sl.value = dih_etane_sl.options[0]\n",
                "            dih_butane_sl.value = dih_butane_sl.options[0]\n",
                "\n",
                "            # get angle value from filepath\n",
                "            angle = filepath[25:28]\n",
                "            if angle.lstrip(\"0\") == '':\n",
                "                angle = \"0\"\n",
                "            else:\n",
                "                angle = angle.lstrip(\"0\")\n",
                "            \n",
                "            xyz_rot = [30, 0, 0]\n",
                "            zoom = 1.8\n",
                "            var_label = \"Ângulo diedral ϕ = {}°\".format(angle)\n",
                "            viewer = init_viewer(xyz, style, xyz_rot, zoom, var_label, options)\n",
                "            \n",
                "        elif dih_buttons.value == \"butane\":\n",
                "            # reset other sliders\n",
                "            dih_hooh_sl.value = dih_hooh_sl.options[0]\n",
                "            dih_etane_sl.value = dih_etane_sl.options[0]\n",
                "            dih_etene_sl.value = dih_etene_sl.options[0]\n",
                "\n",
                "            # get angle value from filepath\n",
                "            angle = filepath[26:29]\n",
                "            if angle.lstrip(\"0\") == '':\n",
                "                angle = \"0\"\n",
                "            else:\n",
                "                angle = angle.lstrip(\"0\")\n",
                "            \n",
                "            xyz_rot = [45, 0, 15]\n",
                "            zoom = 1.8\n",
                "            var_label = \"Ângulo diedral ϕ = {}°\".format(angle)\n",
                "            viewer = init_viewer(xyz, style, xyz_rot, zoom, var_label, options)\n",
                "\n",
                "    viewer.show()\n",
                "\n",
                "dih_buttons = ToggleButtons(\n",
                "    options=[('água oxigenada','hooh'), ('etano', 'etane'), ('eteno', 'etene'), ('butano', 'butane')], \n",
                "    description = ' ', layout=TB_LAYOUT\n",
                "    )\n",
                "\n",
                "dih_hooh_sl = SelectionSlider(\n",
                "    options = load_xyz('hooh'), readout = False, description = ' ',\n",
                "    layout=SS_LAYOUT\n",
                "    )\n",
                "\n",
                "dih_etane_sl = SelectionSlider(\n",
                "    options = load_xyz('etane'), readout = False, description = ' ',\n",
                "    layout=SS_LAYOUT\n",
                "    )\n",
                "\n",
                "dih_etene_sl = SelectionSlider(\n",
                "    options = load_xyz('etene'), readout = False, description = ' ',\n",
                "    layout=SS_LAYOUT\n",
                "    )\n",
                "\n",
                "dih_butane_sl = SelectionSlider(\n",
                "    options = load_xyz('butane'), readout = False, description = ' ',\n",
                "    layout=SS_LAYOUT\n",
                "    )\n",
                "\n",
                "@interact(molecule = dih_buttons)\n",
                "def dih_selector(molecule):\n",
                "    if molecule == 'hooh':\n",
                "        slider = dih_hooh_sl\n",
                "    elif molecule == 'etane':\n",
                "        slider = dih_etane_sl\n",
                "    elif molecule == 'etene':\n",
                "        slider = dih_etene_sl\n",
                "    else:\n",
                "        slider = dih_butane_sl\n",
                "\n",
                "    out = interactive(dih_display, filename = slider)\n",
                "    display(out)"
            ]
        },
        {
            "cell_type": "markdown",
            "id": "32c07922",
            "metadata": {},
            "source": [
                "<div style=\"text-align: justify\"> A energia de torção para um conjunto de moléculas com ângulos diedrais $\\phi_i$ pode ser mimetizada por uma série de cossenos: \n",
                "\n",
                "$$\\mathcal{V}_\\text{tor} = \\sum_\\text{tor} \\sum_{n=1}^4 K_n [1+cos(n \\phi - \\delta_n)]$$\n",
                "\n",
                "onde a primeira somatória corre sobre todas as torções presentes no sistema e a segunda somatória tipicamente possui quatro termos, correspondentes a cossenos com período $n$ de 1 a 4. Os parâmetros $K_n$ e $\\delta_n$ representam a altura e a fase da cada termo de cosseno de cada torção presente. </div>"
            ]
        },
        {
            "cell_type": "markdown",
            "id": "a0928584",
            "metadata": {},
            "source": [
                "<div style=\"text-align: justify\"> O gráfico abaixo mostra a energia de torção em torno do ângulo diedral $\\phi$ calculada por mecânica quântica (bolinhas pretas) e pela equação aproximada pela série de cossenos. Escolha a molécula e teste o efeito dos parâmetros na forma da curva calculada. Note como a somatória dos termos de cosseno permite que curvas com multiplas formas sejam descritas: </div>"
            ]
        },
        {
            "cell_type": "code",
            "execution_count": null,
            "id": "96df0d74",
            "metadata": {},
            "outputs": [],
            "source": [
                "# dih_plot\n",
                "def init_dih_plot(maxd, offset, maxAxis):\n",
                "    fig, ax = plt.subplots(figsize=[6.7, 4])\n",
                "    fig.subplots_adjust(left=0.15, bottom=0.41, right=0.75)\n",
                "    \n",
                "    title = r\"Torsão em torno de $\\phi$:  $\\mathcal{V}_{tor} = \" \\\n",
                "            \"\\sum_{n=1}^4$ K$_n$ [1+cos(n $\\phi$ - $\\delta_n$)]\"\n",
                "    \n",
                "    ax.set_title(title, fontsize=12, pad=10, loc='left')\n",
                "    ax.axis([-np.pi, np.pi, -offset, maxAxis])\n",
                "    \n",
                "    xlabel = u'Ângulo $\\phi$ (rad)'\n",
                "    ylabel = u'Energia relativa (kJ/mol)'\n",
                "    ax.set_xlabel(xlabel, labelpad=1, fontsize=12)\n",
                "    ax.set_ylabel(ylabel, labelpad=5, fontsize=12)\n",
                "    \n",
                "    ## matplotlib_layout\n",
                "    fig.canvas.resizable = False\n",
                "    fig.canvas.toolbar_visible = False\n",
                "    fig.canvas.header_visible = False\n",
                "    ## matplotlib_layout\n",
                "    return fig, ax\n",
                "\n",
                "def get_dih_ref():\n",
                "    files = ['../DATA/ref/ref_hooh.txt', '../DATA/ref/ref_etane.txt',\n",
                "             '../DATA/ref/ref_etene.txt', '../DATA/ref/ref_butane.txt']\n",
                "    ref = []\n",
                "    for filename in files:\n",
                "        with open(filename) as f:\n",
                "            table=[]\n",
                "            for row in f:\n",
                "                row = row.split()\n",
                "                table += [[float(row[0]),float(row[1])]]\n",
                "            ref.append(table)\n",
                "    hooh = np.array(ref[0])\n",
                "    etane = np.array(ref[1])\n",
                "    etene = np.array(ref[2])\n",
                "    butane = np.array(ref[3])\n",
                "    return hooh, etane, etene, butane\n",
                "\n",
                "def dih(t1, n, delta):\n",
                "    return 1+np.cos(n*t1 - delta)\n",
                "\n",
                "# Initialize plot\n",
                "maxd = 20.0\n",
                "offset = 5\n",
                "maxAxis = 20.0\n",
                "\n",
                "dih_fig, dax = init_dih_plot(maxd, offset, maxAxis)\n",
                "\n",
                "# Constants\n",
                "a0 = 2.0\n",
                "f0 = 0\n",
                "maxa = 2*np.pi\n",
                "tt = np.arange(-np.pi, np.pi+0.01, 0.1)\n",
                "tg = tt * 180.0 / np.pi\n",
                "s = a0 * dih(tt, n=1, delta=f0) \n",
                "\n",
                "hooh, etane, etene, butane = get_dih_ref()\n",
                "hooh = dax.scatter(hooh[:,0]*np.pi/180.0, hooh[:,1], visible=True, color='black')\n",
                "etane = dax.scatter(etane[:,0]*np.pi/180.0, etane[:,1], visible=False, color='black')\n",
                "etene = dax.scatter(etene[:,0]*np.pi/180.0, etene[:,1], visible=False, color='black')\n",
                "butane = dax.scatter(butane[:,0]*np.pi/180.0, butane[:,1], visible=False, color='black')\n",
                "\n",
                "d, = dax.plot(tt, s, color=\"#00FC00\")\n",
                "\n",
                "# Sliders\n",
                "ax_k1 = plt.axes([0.14, 0.10, 0.3, 0.02])\n",
                "k1_sl  = Slider(\n",
                "    ax_k1,\n",
                "    '(n=1) K$_1$' , 0.0, maxd, valinit=a0\n",
                ")\n",
                "\n",
                "ax_k2 = plt.axes([0.14, 0.15, 0.3, 0.02])\n",
                "k2_sl  = Slider(\n",
                "    ax_k2,\n",
                "    '(n=2) K$_2$' , 0.0, maxd, valinit=a0\n",
                ")\n",
                "\n",
                "ax_k3 = plt.axes([0.14, 0.20, 0.3, 0.02])\n",
                "k3_sl  = Slider(\n",
                "    ax_k3,\n",
                "    '(n=3) K$_3$' , 0.0, maxd, valinit=a0\n",
                ")\n",
                "\n",
                "ax_k4 = plt.axes([0.14, 0.25, 0.3, 0.02])\n",
                "k4_sl  = Slider(\n",
                "    ax_k4,\n",
                "    '(n=4) K$_4$' , 0.0, maxd, valinit=a0\n",
                ")\n",
                "\n",
                "del1_sl = Slider(\n",
                "    plt.axes([0.56, 0.10, 0.3, 0.02]),\n",
                "    r'$\\delta_1$', 0.0, maxa, valinit=f0\n",
                ")\n",
                "\n",
                "del2_sl = Slider(\n",
                "    plt.axes([0.56, 0.15, 0.3, 0.02]),\n",
                "    r'$\\delta_2$', 0.0, maxa, valinit=f0\n",
                ")\n",
                "\n",
                "del3_sl = Slider(\n",
                "    plt.axes([0.56, 0.20, 0.3, 0.02]),\n",
                "    r'$\\delta_3$', 0.0, maxa, valinit=f0\n",
                ")\n",
                "\n",
                "del4_sl = Slider(\n",
                "    plt.axes([0.56, 0.25, 0.3, 0.02]),\n",
                "    r'$\\delta_4$', 0.0, maxa, valinit=f0\n",
                ")\n",
                "\n",
                "all_sliders = [\n",
                "    k1_sl, k2_sl, k3_sl, k4_sl,\n",
                "    del1_sl, del2_sl, del3_sl, del4_sl\n",
                "]\n",
                "\n",
                "for slider in all_sliders:\n",
                "    slider.vline.set_color('k')\n",
                "    slider.label.set_size(12)\n",
                "\n",
                "def dih_update(val):\n",
                "    real_offset = 0\n",
                "    if dbuttons.value_selected == 'H$_2$O$_2$':\n",
                "        real_offset = offset\n",
                "\n",
                "    elif dbuttons.value_selected == 'etano':\n",
                "        real_offset = offset*0.1\n",
                "\n",
                "    elif dbuttons.value_selected == 'eteno':\n",
                "        real_offset = offset\n",
                "\n",
                "    elif dbuttons.value_selected == 'butano':\n",
                "        real_offset = offset*5\n",
                "        \n",
                "    ua0 = k1_sl.val\n",
                "    ua1 = k2_sl.val\n",
                "    ua2 = k3_sl.val\n",
                "    ua3 = k4_sl.val\n",
                "    uf0 = del1_sl.val\n",
                "    uf1 = del2_sl.val\n",
                "    uf2 = del3_sl.val\n",
                "    uf3 = del4_sl.val\n",
                "    \n",
                "    soma = (ua0*dih(tt, n=1, delta=uf0) + ua1*dih(tt, n=2, delta=uf1) + \n",
                "            ua2*dih(tt, n=3, delta=uf2) + ua3*dih(tt, n=4, delta=uf3)) - real_offset\n",
                "    \n",
                "    d.set_ydata(soma)\n",
                "    dih_fig.canvas.draw_idle()\n",
                "    \n",
                "del1_sl.on_changed(dih_update)\n",
                "k1_sl.on_changed(dih_update)\n",
                "del2_sl.on_changed(dih_update)\n",
                "k2_sl.on_changed(dih_update)\n",
                "del3_sl.on_changed(dih_update)\n",
                "k3_sl.on_changed(dih_update)\n",
                "del4_sl.on_changed(dih_update)\n",
                "k4_sl.on_changed(dih_update)\n",
                "\n",
                "# Diedrais\n",
                "\n",
                "dihax = plt.axes([0.77, 0.71, 0.12, 0.17], facecolor=\"#f5f6fa\")\n",
                "dbuttons = RadioButtons(dihax, ('H$_2$O$_2$' , 'etano', 'eteno', 'butano'))\n",
                "\n",
                "def update_sliders(maxd, a0):\n",
                "    #global ax_k1, k1_sl, ax_k2, k2_sl, ax_k3, k3_sl, ax_k4, k4_sl\n",
                "    global ax_k1\n",
                "    global k1_sl\n",
                "    global ax_k2\n",
                "    global k2_sl\n",
                "    global ax_k3\n",
                "    global k3_sl\n",
                "    global ax_k4\n",
                "    global k4_sl\n",
                "\n",
                "    k1_sl.set_val(a0)\n",
                "    k2_sl.set_val(a0)\n",
                "    k3_sl.set_val(a0)\n",
                "    k4_sl.set_val(a0)\n",
                "\n",
                "    ax_k1.remove()\n",
                "    ax_k2.remove()\n",
                "    ax_k3.remove()\n",
                "    ax_k4.remove()       \n",
                "    \n",
                "    ax_k1 = plt.axes([0.14, 0.10, 0.3, 0.02])\n",
                "    k1_sl = Slider(ax_k1, '(n=1) K$_1$' , 0.0, maxd, valinit=a0)\n",
                "    \n",
                "    ax_k2 = plt.axes([0.14, 0.15, 0.3, 0.02])\n",
                "    k2_sl = Slider(ax_k2, '(n=2) K$_2$' , 0.0, maxd, valinit=a0)\n",
                "    \n",
                "    ax_k3 = plt.axes([0.14, 0.20, 0.3, 0.02])\n",
                "    k3_sl = Slider(ax_k3, '(n=3) K$_3$' , 0.0, maxd, valinit=a0)\n",
                "\n",
                "    ax_k4 = plt.axes([0.14, 0.25, 0.3, 0.02])\n",
                "    k4_sl = Slider(ax_k4, '(n=4) K$_4$' , 0.0, maxd, valinit=a0)\n",
                "    \n",
                "    k1_sl.label.set_size(12)\n",
                "    k2_sl.label.set_size(12)\n",
                "    k3_sl.label.set_size(12)\n",
                "    k4_sl.label.set_size(12)\n",
                "    \n",
                "    _ = k1_sl.on_changed(dih_update)\n",
                "    _ = k2_sl.on_changed(dih_update)\n",
                "    _ = k3_sl.on_changed(dih_update)\n",
                "    _ = k4_sl.on_changed(dih_update)\n",
                "\n",
                "def dih_plot_update(ymin, ymax, visible):\n",
                "    \n",
                "    # reajusta o axes\n",
                "    dax.set_ylim(ymin = -ymin, ymax = ymax)\n",
                "    \n",
                "    # define qual o plot mostrado\n",
                "    hooh.set_visible(visible[0])\n",
                "    etane.set_visible(visible[1])\n",
                "    etene.set_visible(visible[2])\n",
                "    butane.set_visible(visible[3])\n",
                "\n",
                "def dih_switch(label):\n",
                "    visibility = [False for x in range(4)] # hooh, etane, etene, butane\n",
                "    \n",
                "    if dbuttons.value_selected == 'H$_2$O$_2$':\n",
                "        update_sliders(maxd=20.0,a0=2.0)\n",
                "        offset = 5\n",
                "        visibility[0] = True\n",
                "        dih_plot_update(ymin=offset, ymax=20, visible=visibility)\n",
                "\n",
                "    elif dbuttons.value_selected == 'etano':\n",
                "        update_sliders(maxd=20.0,a0=1.0)\n",
                "        offset = 2.5\n",
                "        visibility[1] = True\n",
                "        dih_plot_update(ymin=offset, ymax=10, visible=visibility)\n",
                "\n",
                "    elif dbuttons.value_selected == 'eteno':\n",
                "        update_sliders(maxd=200.0, a0=50.0)\n",
                "        offset = 0\n",
                "        visibility[2] = True\n",
                "        dih_plot_update(ymin=offset, ymax=300, visible=visibility)\n",
                "\n",
                "    elif dbuttons.value_selected == 'butano':\n",
                "        update_sliders(maxd=20.0,a0=5.0)\n",
                "        offset = 20\n",
                "        visibility[3] = True\n",
                "        dih_plot_update(ymin=offset, ymax=70, visible=visibility)\n",
                "\n",
                "_ = dbuttons.on_clicked(dih_switch)\n",
                "        \n",
                "# Reset button\n",
                "dih_ax_reset = plt.axes([0.77, 0.56, 0.12, 0.04])\n",
                "\n",
                "dih_reset_bt  = Button(\n",
                "    dih_ax_reset, 'Reiniciar',\n",
                "    color='#dcdde1', hovercolor='#f5f6fa'\n",
                ")\n",
                "\n",
                "def dih_reset(event):\n",
                "    del1_sl.reset()\n",
                "    k1_sl.reset()\n",
                "    del2_sl.reset()\n",
                "    k2_sl.reset()\n",
                "    del3_sl.reset()\n",
                "    k3_sl.reset()\n",
                "    del4_sl.reset()\n",
                "    k4_sl.reset()\n",
                "\n",
                "_ = dih_reset_bt.on_clicked(dih_reset)\n",
                "\n",
                "# Fit ideal\n",
                "dih_ax_fit = plt.axes([0.77, 0.41, 0.12, 0.04])\n",
                "dih_fit_bt = Button(\n",
                "    dih_ax_fit, label='Ajustar',\n",
                "    color='#dcdde1', hovercolor='#f5f6fa'\n",
                ")\n",
                "\n",
                "def dih_fit(event):\n",
                "    if dbuttons.value_selected == 'H$_2$O$_2$':\n",
                "        k1_sl.set_val(4.55940045)\n",
                "        k2_sl.set_val(5.23880126)\n",
                "        k3_sl.set_val(0.0)\n",
                "        k4_sl.set_val(0.0)\n",
                "        \n",
                "        del1_sl.set_val(0.0)\n",
                "        del2_sl.set_val(0.0)\n",
                "        del3_sl.set_val(0.0)\n",
                "        del4_sl.set_val(0.0)\n",
                "        \n",
                "    elif dbuttons.value_selected == 'etano':\n",
                "        k1_sl.set_val(0.0)\n",
                "        k2_sl.set_val(0.0)\n",
                "        k3_sl.set_val(3.3)\n",
                "        k4_sl.set_val(0.0)\n",
                "        \n",
                "        del1_sl.set_val(0.0)\n",
                "        del2_sl.set_val(0.0)\n",
                "        del3_sl.set_val(0.0)\n",
                "        del4_sl.set_val(0.0)\n",
                "        \n",
                "    elif dbuttons.value_selected == 'eteno':\n",
                "        k1_sl.set_val(0.0)\n",
                "        k2_sl.set_val(98.3)\n",
                "        k3_sl.set_val(0.0)\n",
                "        k4_sl.set_val(0.0)\n",
                "        \n",
                "        del1_sl.set_val(0.0)\n",
                "        del2_sl.set_val(3.14159265)\n",
                "        del3_sl.set_val(0.0)\n",
                "        del4_sl.set_val(0.0)\n",
                "\n",
                "    elif dbuttons.value_selected == 'butano':\n",
                "        k1_sl.set_val(20.0)\n",
                "        k2_sl.set_val(9.05943099)\n",
                "        k3_sl.set_val(8.58190288)\n",
                "        k4_sl.set_val(2.82899633)\n",
                "        \n",
                "        del1_sl.set_val(0.0)\n",
                "        del2_sl.set_val(0.0)\n",
                "        del3_sl.set_val(0.0)\n",
                "        del4_sl.set_val(0.0)\n",
                "        \n",
                "_ = dih_fit_bt.on_clicked(dih_fit)"
            ]
        },
        {
            "cell_type": "markdown",
            "id": "2366790b",
            "metadata": {},
            "source": [
                "<p style=\"text-align: right\">\n",
                "<a href=\"http://gaznevada.iq.usp.br:8080/voila/render/notebooks/index.ipynb\">&#5130; Anterior</a>\n",
                "    | \n",
                "<a href=\"http://gaznevada.iq.usp.br:8080/voila/render/notebooks/dist-carga.ipynb\">Próxima &#5125;</a>\n",
                "</p>"
            ]
        },
        {
            "cell_type": "markdown",
            "id": "d202a6d9",
            "metadata": {},
            "source": [
                "<footer id=\"attribution\" style=\"float:right; color:#999; background:#fff;\">\n",
                "Todos direitos reservados &copy; Guilherme M. Arantes, 2021\n",
                "</footer>"
            ]
        },
        {
            "cell_type": "code",
            "execution_count": null,
            "id": "e3d6e980",
            "metadata": {},
            "outputs": [],
            "source": [
                "# styling notebooks based on voila display\n",
                "HTML(\"\"\"\n",
                "<style>\n",
                "div.jupyter-widgets.widget-container.widget-box.widget-hbox.jupyter-matplotlib {\n",
                "    justify-content: center;\n",
                "    } \n",
                "div.output_area {\n",
                "    place-content: center;\n",
                "}\n",
                "\n",
                "div.lm-Widget.p-Widget.lm-Panel.p-Panel.jupyter-widgets.widget-container.widget-box.widget-vbox.widget-interact {\n",
                "    align-items: center;\n",
                "}\n",
                "\n",
                "div.jupyter-widgets.widget-label {\n",
                "display: none\n",
                "}\n",
                "\n",
                "h1 {\n",
                "        font-family: Arial;\n",
                "}\n",
                "\n",
                "div.text_cell_render{\n",
                "        font-family: Arial;\n",
                "        line-height: 145%;\n",
                "        font-size: 130%;\n",
                "        font-weight: 400;\n",
                "        width:800px;\n",
                "        margin-left:auto;\n",
                "        margin-right:auto;\n",
                "}\n",
                "\n",
                "</style>\"\"\")"
            ]
        }
    ],
    "metadata": {
        "kernelspec": {
            "display_name": "Python 3 (ipykernel)",
            "language": "python",
            "name": "python3"
        },
        "language_info": {
            "codemirror_mode": {
                "name": "ipython",
                "version": 3
            },
            "file_extension": ".py",
            "mimetype": "text/x-python",
            "name": "python",
            "nbconvert_exporter": "python",
            "pygments_lexer": "ipython3",
            "version": "3.9.5"
        }
    },
    "nbformat": 4,
    "nbformat_minor": 5
}
